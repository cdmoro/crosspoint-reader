<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrossPoint Reader - Settings</title>
  <style>
    :root {
      --font-color: #333;
      --bg: #f5f5f5;
      --card-bg: #fff;
      --label-color: #7f8c8d;
      --border-color: #eee;
      --accent-color: #6e9a82;
      --accent-color-50: #6e9a8280;
      --accent-hover-color: #5a8c73;
      --toggle-bg: #ccc;
      --muted-color: #95a5a6;
      --input-border: #c5c9cc;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --font-color: #f5f5f5;
        --bg: #333;
        --card-bg: #444;
        --label-color: #bdc3c7;
        --border-color: #555;
        --toggle-bg: #666;
        --input-border: #6c7176;
        color-scheme: dark;
      }
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Oxygen, Ubuntu, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--bg);
      color: var(--font-color);
    }
    h1 {
      margin-top: 0;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 svg {
      background-color: var(--accent-color);
      padding: 4px;
      border-radius: 4px;
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card h3 {
      margin: 0;
      font-size: 18px;
      padding-bottom: 8px;
    }
    .nav-links {
      margin: 20px 0;
      display: flex;
      gap: 10px;
    }
    .nav-links a {
      padding: 10px 20px;
      color: var(--font-color);
      text-decoration: none;
      border-radius: 4px;
    }
    .nav-links a.active {
      background-color: var(--accent-color);
      color: #fff;
    }
    .nav-links a:hover {
      background-color: var(--accent-hover-color);
      color: #fff;
    }
    .setting-row {
      display: flex;
      gap: 6px;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .setting-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .setting-name {
      color: var(--label-color);
    }
    .setting-row select,
    .setting-row input {
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.95em;
      background: var(--card-bg);
      border-width: 1px;
      border: solid 1px var(--input-border);
    }
    .setting-row input[type="text"],
    .setting-row input[type="password"] {
      width: 150px;
    }
    .setting-row input[type="number"] {
      width: 80px;
    }
    /* Toggle switch */
    .toggle-switch {
      display: inline-block;
      position: relative;
      width: 48px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--toggle-bg);
      border-radius: 26px;
      transition: 0.3s;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--accent-color);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    #save-container {
      display: flex;
      justify-content: center;
      margin: 20px 0 30px;
    }
    #toast {
      padding: 12px;
      border-radius: 4px;
      display: none;
      position: fixed;
      left: 16px;
      bottom: 16px;
      min-width: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .toast-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .toast-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .toast-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .loader-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #AAA;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    .btn {
      color: #fff;
      padding: 8px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 16px;
      line-height: 1.5;
    }
    .btn-lg {
      padding: 0.5rem 1rem;
      font-size: 1.25rem;
      border-radius: 0.5rem;
    }
    .btn-primary {
      background-color: var(--accent-color);
    }
    .btn-primary:hover {
      background-color: var(--accent-hover-color);
    }
    .btn-primary:disabled {
      background-color: var(--accent-color-50);
      cursor: not-allowed;
      color: var(--muted-color)
    }
    @keyframes rotation {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      body {
        padding: 10px;
        font-size: 14px;
      }
      .toast {
        left: 10px;
        bottom: 10px;
        right: 10px;
      }
      .card {
        padding: 12px;
        margin: 10px 0;
      }
      .setting-row {
        padding: 4px 0;
        border: none;
      }
      .setting-row select {
        min-width: 0;
        width: unset;
      }
      .setting-row input[type="text"],
      .setting-row input[type="password"] {
        width: 100px;
      }
      footer {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <h1>
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 162 180"><path fill="#000" d="M141.133 1.938c8.969-5.38 20.384 1.079 20.388 11.537v153.051c-.004 10.458-11.419 16.916-20.388 11.537l-60.374-36.226-60.372 36.226C11.417 183.442.003 176.984 0 166.526V13.475C.003 3.017 11.418-3.441 20.387 1.938L80.76 38.16zm-19.858 115.586-28.89 17.34 54.896 32.947c.996.597 2.261-.126 2.264-1.285v-65.959zM14.239 12.19c-.995-.598-2.26.125-2.263 1.285v73.137l62.796 37.678V48.51z"/><path fill="#fff" d="m121.275 117.524-28.89 17.34 54.896 32.947c.996.597 2.261-.126 2.264-1.285v-65.959ZM14.24 12.19c-.996-.598-2.26.125-2.264 1.285v73.137l62.797 37.678V48.51Z"/></svg>
    CrossPoint Reader
  </h1>

  <div class="nav-links">
    <a href="/">Home</a>
    <a href="/files">File Manager</a>
    <a href="/settings" class="active">Settings</a>
  </div>

  <h2>Settings</h2>

  <div id="toast"></div>

  <div id="settings-container">
    <div class="card loader-container">
      <span class="loader"></span>
    </div>
  </div>

  <div id="save-container">
    <button class="btn btn-lg btn-primary" id="saveBtn" onclick="saveSettings(event)" disabled>Save Settings</button>
  </div>

  <footer>CrossPoint Reader â€¢ Open Source</footer>

<script>
  let allSettings = [];
  let originalValues = {};
  let toastTimeout = null;

  function escapeHtml(unsafe) {
    return unsafe
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function showToast(text, type = "info") {
    if (toastTimeout) clearTimeout(toastTimeout);
    const toast = document.getElementById('toast');
    toast.textContent = text;
    toast.className = 'toast toast-' + type;
    toast.style.display = 'block';
    toastTimeout = setTimeout(() => toast.style.display = 'none', 4000);
  }

  function renderControl(setting) {
    const id = 'setting-' + setting.key;

    if (setting.type === 'toggle') {
      const checked = setting.value ? 'checked' : '';
      return `<label class="toggle-switch">
        <input type="checkbox" id="${id}" ${checked} onchange="markChanged()">
        <span class="toggle-slider"></span></label>`;
    }

    if (setting.type === 'enum') {
      let html = `<select id="${id}" onchange="markChanged()">`;
      setting.options.forEach((opt, idx) => {
        const selected = idx === setting.value ? ' selected' : '';
        html += `<option value="${idx}"${selected}>${escapeHtml(opt)}</option>`;
      });
      html += '</select>';
      return html;
    }

    if (setting.type === 'value') {
      return `<input type="number" id="${id}" value="${setting.value}" min="${setting.min}" max="${setting.max}" step="${setting.step}" onchange="markChanged()">`;
    }

    if (setting.type === 'string') {
      const inputType = setting.name.toLowerCase().includes('password') ? 'password' : 'text';
      return `<input type="${inputType}" id="${id}" value="${escapeHtml(setting.value || '')}" oninput="markChanged()">`;
    }
  }

  function getValue(setting) {
    const el = document.getElementById('setting-' + setting.key);
    if (!el) return undefined;

    switch (setting.type) {
      case 'toggle':
        return el.checked ? 1 : 0;
      case 'enum': case 'value':
        return parseInt(el.value, 10);
      case 'string':
        return el.value;
      default:
        return undefined;
    }
  }

  function markChanged() {
    document.getElementById('saveBtn').disabled = false;
  }

  async function loadSettings() {
    try {
      const response = await fetch('/api/settings');
      if (!response.ok) {
        throw new Error('Failed to load settings: ' + response.status);
      }
      allSettings = await response.json();

      // Store original values
      originalValues = {};
      allSettings.forEach(function(s) {
        originalValues[s.key] = s.value;
      });

      // Group by category
      const groups = {};
      allSettings.forEach(function(s) {
        if (!groups[s.category]) groups[s.category] = [];
        groups[s.category].push(s);
      });

      const container = document.getElementById('settings-container');
      let html = '';

      for (const category in groups) {
        html += '<div class="card"><h3>' + escapeHtml(category) + '</h3>';
        groups[category].forEach(s => {
          if (!['toggle', 'enum', 'value', 'string'].includes(s.type)) return;

          html += `<div class="setting-row">
            <span class="setting-name">${escapeHtml(s.name)}</span>
            ${renderControl(s)}
            </div>`;
        });
        html += '</div>';
      }

      container.innerHTML = html;
      document.getElementById('save-container').style.display = '';
      document.getElementById('saveBtn').disabled = true;
    } catch (e) {
      console.error(e);
      document.getElementById('settings-container').innerHTML =
        '<div class="card"><p style="text-align:center;color:#ff6347;">Failed to load settings</p></div>';
    }
  }

  async function saveSettings(event) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Saving...';

    // Collect only changed values
    const changes = {};
    allSettings.forEach(function(s) {
      const current = getValue(s);
      if (current !== undefined && current !== originalValues[s.key]) {
        changes[s.key] = current;
      }
    });

    if (Object.keys(changes).length === 0) {
      showToast('No changes to save.');
      btn.textContent = 'Save Settings';
      return;
    }

    try {
      const response = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(changes)
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || 'Save failed');
      }

      // Update original values to new values
      for (const key in changes) {
        originalValues[key] = changes[key];
      }

      showToast('Settings saved successfully!', "success");
    } catch (e) {
      console.error(e);
      showToast('Error: ' + e.message, "error");
    }

    btn.textContent = 'Save Settings';
  }

  loadSettings();
</script>
</body>
</html>
